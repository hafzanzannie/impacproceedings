<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMPAC Proceedings Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            color: #333d45;
        }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background-color: #ffffff;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.25);
        }
        .table-cell-input {
            width: 100%;
            height: 100%;
            padding: 0.5rem;
            background-color: transparent;
            border: none;
            outline: none;
            font-size: 0.875rem;
        }
        .action-btn {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            transition: background-color 0.2s;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fff;
            padding: 24px;
            border-radius: 0.5rem;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .modal-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        @media print {
            body { background-color: white; }
            header, footer, .mb-6, .flex-wrap, #form-page, #search-input, #print-btn, #export-excel-btn, #go-back-btn { display: none !important; }
            #data-page { display: block !important; padding: 0 !important; margin: 0 !important; width: 100% !important; }
            .bg-white, .shadow-lg, .border, .border-gray-200 { box-shadow: none !important; border: none !important; }
            table { width: 100%; font-size: 8pt; border-collapse: collapse; }
            th, td { border: 1px solid #000; padding: 4px; }
            .no-print { display: none !important; }
        }
        .table-container {
            position: relative;
            max-height: 70vh;
            overflow-y: auto;
        }
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .table-row-hover:hover {
            background-color: #f1f5f9;
        }
        .auto-fit-table {
            table-layout: fixed;
            width: 100%;
        }
        .auto-fit-table td, .auto-fit-table th {
            overflow: hidden;
            word-wrap: break-word;
        }
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }
    </style>
</head>
<body class="antialiased p-4">

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="text-center">
            <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <div class="mt-2 text-sm text-gray-700">Connecting to cloud database...</div>
        </div>
    </div>

    <!-- Form Page -->
    <div id="form-page" class="container mx-auto max-w-2xl" style="display: none;">
        <header class="mb-6 flex flex-col md:flex-row justify-between items-center">
            <div class="text-center md:text-left mb-4 md:mb-0">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800">IMPAC Proceedings Tracker</h1>
                <h3 class="text-xs italic text-gray-500 mt-1">Developed by Hafzan Zannie Hamza with Gemini</h3>
                <div id="user-id-display" class="text-xs text-gray-400 mt-2"></div>
            </div>
            <button id="view-data-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg shadow-md transition-colors">
                View All Data
            </button>
        </header>

        <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 space-y-4">
            <div class="grid md:grid-cols-2 gap-4">
                <!-- Submission ID -->
                <div>
                    <label for="submissionId" class="block text-sm font-medium text-gray-700">Submission ID <span class="text-red-500">*</span></label>
                    <input type="text" id="submissionId" class="form-input mt-1" placeholder="e.g., 2024-001" required>
                </div>
                <!-- Submission Date -->
                <div>
                    <label for="submissionDate" class="block text-sm font-medium text-gray-700">Submission Date</label>
                    <input type="date" id="submissionDate" class="form-input mt-1">
                </div>
            </div>
            <!-- Article Title -->
            <div>
                <label for="articleTitle" class="block text-sm font-medium text-gray-700">Article Title <span class="text-red-500">*</span></label>
                <input type="text" id="articleTitle" class="form-input mt-1" placeholder="e.g., The Role of AI in Scientific Discovery" required>
            </div>
            <div class="grid md:grid-cols-2 gap-4">
                <!-- Corresponding Author -->
                <div>
                    <label for="correspondingAuthor" class="block text-sm font-medium text-gray-700">Corresponding Author</label>
                    <input type="text" id="correspondingAuthor" class="form-input mt-1" placeholder="e.g., Dr. Evelyn Reed">
                </div>
                <!-- Author Email -->
                <div>
                    <label for="authorEmail" class="block text-sm font-medium text-gray-700">Author Email</label>
                    <input type="email" id="authorEmail" class="form-input mt-1" placeholder="e.g., e.reed@university.edu">
                </div>
            </div>
            <!-- Article DOI -->
            <div>
                <label for="articleDoi" class="block text-sm font-medium text-gray-700">Article DOI</label>
                <input type="text" id="articleDoi" class="form-input mt-1" placeholder="e.g., 10.1000/xyz.abc.123">
            </div>
            <!-- Article Status -->
            <div>
                <label for="articleStatus" class="block text-sm font-medium text-gray-700">Article Status</label>
                <select id="articleStatus" class="form-select mt-1">
                    <option value="Submitted">Submitted</option>
                    <option value="Under Initial Review">Under Initial Review</option>
                    <option value="Sent for Peer Review">Sent for Peer Review</option>
                    <option value="Under Revision">Under Revision</option>
                    <option value="Accepted">Accepted</option>
                    <option value="Rejected">Rejected</option>
                    <option value="In Production">In Production</option>
                    <option value="Published">Published</option>
                </select>
            </div>
            <!-- Editor Assigned -->
            <div>
                <label for="editorAssigned" class="block text-sm font-medium text-gray-700">Editor Assigned</label>
                <input type="text" id="editorAssigned" class="form-input mt-1" placeholder="e.g., Dr. Smith">
            </div>
            <!-- Reviewers Assigned -->
            <div>
                <label for="reviewersAssigned" class="block text-sm font-medium text-gray-700">Reviewers Assigned</label>
                <input type="text" id="reviewersAssigned" class="form-input mt-1" placeholder="e.g., Dr. A, Dr. B">
            </div>
            <div class="grid md:grid-cols-2 gap-4">
                <!-- Reviewer Deadline -->
                <div>
                    <label for="reviewerDeadline" class="block text-sm font-medium text-gray-700">Reviewer Deadline</label>
                    <input type="date" id="reviewerDeadline" class="form-input mt-1">
                </div>
                <!-- Date Reviews Contacted -->
                <div>
                    <label for="dateReviewsContacted" class="block text-sm font-medium text-gray-700">Date Reviews Contacted</label>
                    <input type="date" id="dateReviewsContacted" class="form-input mt-1">
                </div>
            </div>
            <!-- Date Reviews Received -->
            <div>
                <label for="dateReviewsReceived" class="block text-sm font-medium text-gray-700">Date Reviews Received</label>
                    <input type="date" id="dateReviewsReceived" class="form-input mt-1">
                </div>
            <!-- Final Decision -->
            <div>
                <label for="finalDecision" class="block text-sm font-medium text-gray-700">Final Decision</label>
                <input type="text" id="finalDecision" class="form-input mt-1" placeholder="e.g., Accept">
            </div>
            <div class="grid md:grid-cols-2 gap-4">
                <!-- Decision Date -->
                <div>
                    <label for="decisionDate" class="block text-sm font-medium text-gray-700">Decision Date</label>
                    <input type="date" id="decisionDate" class="form-input mt-1">
                </div>
                <!-- Issue/Volume -->
                <div>
                    <label for="issueVolume" class="block text-sm font-medium text-gray-700">Issue/Volume</label>
                    <input type="text" id="issueVolume" class="form-input mt-1" placeholder="e.g., Vol 10, Issue 2">
                </div>
            </div>
            <!-- Publication Date -->
            <div>
                <label for="publicationDate" class="block text-sm font-medium text-gray-700">Publication Date</label>
                <input type="date" id="publicationDate" class="form-input mt-1">
            </div>
            <!-- Notes -->
            <div>
                <label for="notes" class="block text-sm font-medium text-gray-700">Notes</label>
                <textarea id="notes" class="form-textarea mt-1" rows="3" placeholder="Add any relevant notes here..."></textarea>
            </div>
            
            <button id="submit-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg shadow-md transition-colors">
                Submit Article
            </button>
            <div id="status-message" class="mt-4 text-center hidden font-semibold"></div>
        </div>
    </div>

    <!-- Data Page -->
    <div id="data-page" class="container mx-auto" style="display: none;">
        <header class="mb-6 flex flex-col md:flex-row justify-between items-center">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4 md:mb-0">All Saved Articles</h1>
            <div class="flex flex-wrap justify-center gap-4">
                <button id="go-back-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg shadow-md transition-colors">
                    Go Back to Form
                </button>
                <button id="export-excel-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg shadow-md transition-colors">
                    Export to Excel
                </button>
                <button id="print-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg shadow-md transition-colors">
                    Print
                </button>
            </div>
        </header>

        <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 mt-4">
            <input type="text" id="search-input" placeholder="Search by Submission ID, Title, or Author..." class="form-input mb-4">
            <div class="text-xs text-gray-500 mb-4">
                Click on any table header to sort. Use the search box above to filter entries.
            </div>
            <div class="table-container border border-gray-200 rounded-lg">
                <table class="w-full text-sm text-left text-gray-500 auto-fit-table">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky-header">
                        <tr id="table-headers">
                            <!-- Headers populated by JS -->
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <!-- Rows populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Custom Modal -->
    <div id="confirmation-modal" class="modal">
        <div class="modal-content">
            <p class="text-gray-800 font-medium text-lg mb-4">Are you sure you want to delete this article?</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-delete-btn" class="modal-btn bg-red-600 hover:bg-red-700 text-white">Delete</button>
                <button id="cancel-delete-btn" class="modal-btn bg-gray-200 hover:bg-gray-300 text-gray-800">Cancel</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules for app initialization, authentication, and Firestore database
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', async function () {
            const formPage = document.getElementById('form-page');
            const dataPage = document.getElementById('data-page');
            const viewDataBtn = document.getElementById('view-data-btn');
            const goBackBtn = document.getElementById('go-back-btn');
            const submitBtn = document.getElementById('submit-btn');
            const exportExcelBtn = document.getElementById('export-excel-btn');
            const printBtn = document.getElementById('print-btn');
            const statusMessage = document.getElementById('status-message');
            const confirmationModal = document.getElementById('confirmation-modal');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            const searchInput = document.getElementById('search-input');
            const loadingOverlay = document.getElementById('loading-overlay');
            const userIdDisplay = document.getElementById('user-id-display');
            
            let db;
            let auth;
            let editingDocId = null;
            let currentUserId = null;
            let sortState = { column: null, direction: 'asc' };
            
            // Define the structure of the data and table headers
            const spreadsheetData = [
                { id: 'submissionId', title: 'Submission ID' },
                { id: 'submissionDate', title: 'Submission Date', type: 'date' },
                { id: 'articleTitle', title: 'Article Title' },
                { id: 'correspondingAuthor', title: 'Corresponding Author' },
                { id: 'authorEmail', title: 'Author Email' },
                { id: 'articleDoi', title: 'Article DOI' },
                { id: 'articleStatus', title: 'Article Status' },
                { id: 'editorAssigned', title: 'Editor Assigned' },
                { id: 'reviewersAssigned', title: 'Reviewers Assigned' },
                { id: 'reviewerDeadline', title: 'Reviewer Deadline', type: 'date' },
                { id: 'dateReviewsContacted', title: 'Date Reviews Contacted', type: 'date' },
                { id: 'dateReviewsReceived', title: 'Date Reviews Received', type: 'date' },
                { id: 'finalDecision', title: 'Final Decision' },
                { id: 'decisionDate', title: 'Decision Date', type: 'date' },
                { id: 'issueVolume', title: 'Issue/Volume' },
                { id: 'publicationDate', title: 'Publication Date', type: 'date' },
                { id: 'notes', title: 'Notes' }
            ];

            const tableHeadersTitles = ['No.', 'Actions', 'Submission ID', 'Submission Date', 'Article Title', 'Corresponding Author', 'Author Email', 'Article DOI', 'Article Status', 'Editor Assigned', 'Reviewers Assigned', 'Reviewer Deadline', 'Date Reviews Contacted', 'Date Reviews Received', 'Final Decision', 'Decision Date', 'Issue/Volume', 'Publication Date', 'Notes'];

            // Function to format date strings for display
            function formatDate(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString + 'T00:00:00'); 
                return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            }

            // Function to switch between the form and data views
            function showPage(pageId) {
                formPage.style.display = (pageId === 'form-page') ? 'block' : 'none';
                dataPage.style.display = (pageId === 'data-page') ? 'block' : 'none';
                if (pageId === 'data-page' && currentUserId) {
                    renderTable(currentUserId);
                }
            }
            
            // Function to show status messages (success or error)
            function showStatus(message, isError = false) {
                statusMessage.textContent = message;
                statusMessage.classList.remove('hidden', 'text-red-600', 'text-green-600');
                statusMessage.classList.add(isError ? 'text-red-600' : 'text-green-600');
                setTimeout(() => {
                    statusMessage.classList.add('hidden');
                }, 3000);
            }
            
            // Functions for the confirmation modal
            function showConfirmModal(onConfirm) {
                confirmationModal.style.display = 'flex';
                confirmDeleteBtn.onclick = () => {
                    onConfirm();
                    hideConfirmModal();
                };
                cancelDeleteBtn.onclick = hideConfirmModal;
            }

            function hideConfirmModal() {
                confirmationModal.style.display = 'none';
                confirmDeleteBtn.onclick = null;
                cancelDeleteBtn.onclick = null;
            }

            // Get data from form inputs
            function getFormData() {
                const data = {};
                spreadsheetData.forEach(field => {
                    const element = document.getElementById(field.id);
                    data[field.id] = element.value;
                });
                return data;
            }

            // Populate form with data for editing
            function setFormData(data) {
                spreadsheetData.forEach(field => {
                    const element = document.getElementById(field.id);
                    element.value = data[field.id] || '';
                });
            }

            // Clear all form fields
            function clearForm() {
                setFormData({});
                editingDocId = null;
                submitBtn.textContent = 'Submit Article';
            }
            
            // Sort data based on column and direction
            function sortData(data, key, direction) {
                if (!key) return data;
                return data.sort((a, b) => {
                    const valA = a.data[key] || '';
                    const valB = b.data[key] || '';
                    if (direction === 'asc') {
                        return valA.localeCompare(valB, undefined, { numeric: true, sensitivity: 'base' });
                    } else {
                        return valB.localeCompare(valA, undefined, { numeric: true, sensitivity: 'base' });
                    }
                });
            }
            
            // Filter data based on search term
            function filterData(data, searchTerm) {
                if (!searchTerm) {
                    return data;
                }
                const lowerCaseSearchTerm = searchTerm.toLowerCase();
                return data.filter(article => {
                    const searchableFields = ['submissionId', 'articleTitle', 'correspondingAuthor'];
                    return searchableFields.some(field => (article.data[field] || '').toLowerCase().includes(lowerCaseSearchTerm));
                });
            }

            // Render table headers
            function renderHeaders() {
                const tableHeaders = document.getElementById('table-headers');
                tableHeaders.innerHTML = '';
                tableHeadersTitles.forEach((title, index) => {
                    const th = document.createElement('th');
                    th.scope = 'col';
                    let className = 'px-2 py-3 border-r last:border-r-0 border-gray-200 cursor-pointer';

                    // Add sorting indicator and logic, excluding 'No.' and 'Actions'
                    if (index > 1) { 
                        const colId = spreadsheetData[index - 2].id;
                        th.dataset.column = colId;
                        th.addEventListener('click', () => handleSort(colId));
                        if (sortState.column === colId) {
                            title += sortState.direction === 'asc' ? ' ▲' : ' ▼';
                        }
                    } else {
                        className = 'px-2 py-3 border-r border-gray-200 no-print';
                    }

                    if (index === 0) { // 'No.' column
                        className = 'px-2 py-3 border-r border-gray-200';
                        th.classList.remove('cursor-pointer');
                    } else if (index === 1) { // 'Actions' column
                        className = 'px-2 py-3 border-r border-gray-200 no-print';
                        th.classList.remove('cursor-pointer');
                    }
                    th.className = className;
                    th.textContent = title;
                    tableHeaders.appendChild(th);
                });
            }
            
            // Handle sorting logic
            function handleSort(column) {
                if (sortState.column === column) {
                    sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    sortState.column = column;
                    sortState.direction = 'asc';
                }
                renderTable();
            }

            // Real-time rendering of the table using Firestore onSnapshot
            let unsubscribe = null; // Variable to store the listener
            async function renderTable() {
                if (!db || !currentUserId) {
                    console.error("Database or user not ready.");
                    return;
                }
                
                // If a previous listener exists, unsubscribe to avoid memory leaks
                if (unsubscribe) {
                    unsubscribe();
                }

                const tableBody = document.getElementById('table-body');
                tableBody.innerHTML = '';
                
                const userId = auth.currentUser?.uid;
                const articlesCollection = collection(db, 'artifacts', typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', 'users', userId, 'articles');
                
                // Use onSnapshot to get real-time updates
                unsubscribe = onSnapshot(articlesCollection, (querySnapshot) => {
                    let allArticles = [];
                    querySnapshot.forEach((doc) => {
                        allArticles.push({ id: doc.id, data: doc.data() });
                    });
                    
                    const searchTerm = searchInput.value;
                    allArticles = filterData(allArticles, searchTerm);
                    allArticles = sortData(allArticles, sortState.column, sortState.direction);
                    
                    tableBody.innerHTML = ''; // Clear table before rendering
                    
                    if (allArticles.length === 0) {
                        const tr = document.createElement('tr');
                        tr.className = 'bg-white';
                        tr.innerHTML = `<td colspan="${tableHeadersTitles.length}" class="px-6 py-4 text-center text-gray-400 italic">No matching articles found.</td>`;
                        tableBody.appendChild(tr);
                        return;
                    }

                    allArticles.forEach((article, index) => {
                        const tr = document.createElement('tr');
                        tr.className = 'bg-white border-b table-row-hover';
                        
                        // Serial Number column
                        const serialNumberTd = document.createElement('td');
                        serialNumberTd.className = 'px-2 py-2 border-r border-gray-200 font-medium text-gray-900';
                        serialNumberTd.textContent = index + 1;
                        tr.appendChild(serialNumberTd);

                        // Actions column
                        const actionsTd = document.createElement('td');
                        actionsTd.className = 'px-2 py-2 border-r border-gray-200 no-print';
                        actionsTd.innerHTML = `
                            <button class="action-btn text-blue-600 hover:text-blue-800 font-bold" onclick="editArticle('${article.id}')">Edit</button>
                            <button class="action-btn text-red-600 hover:text-red-800 ml-2 font-bold" onclick="showDeleteConfirm('${article.id}')">Delete</button>
                        `;
                        tr.appendChild(actionsTd);

                        spreadsheetData.forEach(col => {
                            const td = document.createElement('td');
                            td.className = 'px-2 py-2 border-r last:border-r-0 border-gray-200';
                            const value = article.data[col.id] || '';
                            td.textContent = (col.type === 'date' && value) ? formatDate(value) : value;
                            tr.appendChild(td);
                        });
                        tableBody.appendChild(tr);
                    });
                }, (error) => {
                    console.error("Error fetching data: ", error);
                    showStatus('Failed to load data. Please try again later.', true);
                });
            }
            
            // Function to handle editing an article
            window.editArticle = async function(docId) {
                const docRef = doc(db, 'artifacts', typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', 'users', currentUserId, 'articles', docId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    setFormData(docSnap.data());
                    editingDocId = docId;
                    submitBtn.textContent = 'Update Article';
                    showPage('form-page');
                } else {
                    showStatus('Article not found.', true);
                }
            };

            // Function to handle deleting an article
            window.showDeleteConfirm = function(docId) {
                showConfirmModal(async () => {
                    try {
                        const docRef = doc(db, 'artifacts', typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', 'users', currentUserId, 'articles', docId);
                        await deleteDoc(docRef);
                        showStatus('Article deleted successfully!');
                    } catch (e) {
                        console.error("Error removing document: ", e);
                        showStatus('Failed to delete article.', true);
                    }
                });
            };
            
            // Export data to CSV (Excel compatible)
            function exportToExcel() {
                const articlesRef = collection(db, 'artifacts', typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', 'users', currentUserId, 'articles');
                getDocs(articlesRef).then(querySnapshot => {
                    const allArticles = querySnapshot.docs.map(doc => doc.data());
                    if (allArticles.length === 0) {
                        showStatus('No data to export.', true);
                        return;
                    }
                    
                    const headers = tableHeadersTitles.filter(title => title !== 'Actions' && title !== 'No.').map(title => `"${title}"`).join(',');
                    let csv = headers + '\n';
                    allArticles.forEach(article => {
                        const rowData = spreadsheetData.map(col => `"${(article[col.id] || '').replace(/"/g, '""')}"`).join(',');
                        csv += rowData + '\n';
                    });

                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'journal_tracker_data.csv';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }).catch(e => {
                    console.error("Error exporting data: ", e);
                    showStatus('Failed to export data.', true);
                });
            }
            
            function printTable() {
                window.print();
            }

            // Handle form submission
            submitBtn.addEventListener('click', async () => {
                const formData = getFormData();
                if (!formData.submissionId || !formData.articleTitle) {
                    showStatus('Submission ID and Article Title are required.', true);
                    return;
                }
                
                try {
                    const articlesCollection = collection(db, 'artifacts', typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', 'users', currentUserId, 'articles');
                    if (editingDocId) {
                        const docRef = doc(articlesCollection, editingDocId);
                        await updateDoc(docRef, formData);
                        showStatus('Article updated successfully!');
                    } else {
                        await addDoc(articlesCollection, formData);
                        showStatus('Article submitted successfully!');
                    }
                    clearForm();
                    showPage('data-page'); 
                } catch (e) {
                    console.error("Error adding/updating document: ", e);
                    showStatus('An error occurred. Please try again.', true);
                }
            });

            // Event listeners for UI navigation and actions
            viewDataBtn.addEventListener('click', () => showPage('data-page'));
            goBackBtn.addEventListener('click', () => {
                showPage('form-page');
                clearForm();
            });
            exportExcelBtn.addEventListener('click', exportToExcel);
            printBtn.addEventListener('click', printTable);
            searchInput.addEventListener('input', renderTable);
            
            // --- Firebase Initialization and Auth ---
            try {
                // Get the unique app ID and Firebase config from the global variables
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = JSON.parse(__firebase_config);

                // Initialize Firebase app and services
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Handle initial authentication
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // Set up the authentication state listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        userIdDisplay.textContent = `Your unique user ID: ${currentUserId}`;
                        loadingOverlay.style.display = 'none';
                        showPage('form-page');
                        renderHeaders(); // Render headers after auth is ready
                    } else {
                        // User is signed out.
                        console.log("User is signed out.");
                        // Handle re-authentication or show a message
                        loadingOverlay.style.display = 'none';
                    }
                });
            } catch (e) {
                console.error("Firebase initialization failed: ", e);
                loadingOverlay.style.display = 'none';
                statusMessage.textContent = 'Failed to connect to the database. Please try again.';
                statusMessage.classList.remove('hidden');
                formPage.style.display = 'block'; // Show form page even if database fails
            }
        });
    </script>
</body>
</html>
